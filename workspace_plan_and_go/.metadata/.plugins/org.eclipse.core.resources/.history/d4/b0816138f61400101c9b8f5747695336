package com.plan_and_go.plan_and_go_Prj.mypage.controller;

import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.servlet.ModelAndView;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import com.plan_and_go.plan_and_go_Prj.member.vo.MemberVO;
import com.plan_and_go.plan_and_go_Prj.mypage.service.MyPageService;
import com.plan_and_go.plan_and_go_Prj.mypage.vo.MyPageVO;
import com.plan_and_go.plan_and_go_Prj.place.vo.PlaceVO;

@Controller("myPageController")
public class MyPageControllerImpl implements MyPageController {

    @Autowired
    private MyPageService myPageService;

    /**
     * ê¸°ë³¸ ìš”ì²­ ì²˜ë¦¬ ë©”ì„œë“œ
     */
    @Override
    @RequestMapping(value = "/board/myPage.do", method = {RequestMethod.POST})
    public ModelAndView showMyPage(HttpServletRequest request, HttpServletResponse response) throws Exception {
    	request.setCharacterEncoding("utf-8");
		response.setContentType("html/text;charset=utf-8");
    	
    	String viewName = (String) request.getAttribute("viewName");
        String memberId = request.getParameter("MEMBER_ID");
        System.out.println("memberID in controller : " + memberId);
        MemberVO member = myPageService.getMemberDetails(memberId);
        List<PlaceVO> visitedPlaces = myPageService.getVisitedPlaces(memberId);
        List<MyPageVO> schedules = myPageService.getSchedulesByMemberId(memberId);
        
        System.out.println("visitedPlaces = " + visitedPlaces);
        System.out.println("schedules = " + schedules);
        System.out.println("member = " + member);	

        ModelAndView mav = new ModelAndView(viewName);
        mav.addObject("member", member);
        mav.addObject("visitedPlaces", visitedPlaces);
        mav.addObject("schedules", schedules);

        return mav;
    }

    /**
     * í”„ë¡œí•„ ìˆ˜ì • ì²˜ë¦¬
     */
    @Override
    @RequestMapping(value = "/board/updateProfile.do", method = RequestMethod.POST)
    public ModelAndView updateProfile(HttpServletRequest request, HttpServletResponse response) throws Exception {
        String memberId = request.getParameter("MEMBER_ID");

        MemberVO memberVO = new MemberVO();
        memberVO.setMEMBER_ID(memberId);
        myPageService.updateMemberDetails(memberVO);

        return new ModelAndView("redirect:/board/myPage.do?memberId=" + memberId);
    }

    /*
     * ì¼ì • ì‚­ì œ ì²˜ë¦¬
     */
    @Override
    @RequestMapping(value = "/board/deleteSchedule.do", method = RequestMethod.POST)
    public ModelAndView deleteSchedule(HttpServletRequest request, HttpServletResponse response) throws Exception {
        int scheduleId = Integer.parseInt(request.getParameter("scheduleId"));
        String memberId = request.getParameter("MEMBER_ID");

        myPageService.deleteSchedule(scheduleId);

        ModelAndView mav = new ModelAndView("board/redirectPostToMyPage"); // redirectPostToMyPage.jsp
        mav.addObject("MEMBER_ID", memberId);
        return mav;
    }
    
    @RequestMapping(value = "/board/shareSchedule.do", method = RequestMethod.POST)
    public ModelAndView  shareSchedule(HttpServletRequest request, RedirectAttributes redirectAttributes) throws Exception {
        int GROUP_ID = Integer.parseInt(request.getParameter("GROUP_ID"));
        String MEMBER_ID = request.getParameter("MEMBER_ID");
        String NICKNAME = request.getParameter("NICKNAME");
        
        MyPageVO myPageVO = new MyPageVO();
        
        myPageVO.setGROUP_ID(GROUP_ID);
        myPageVO.setNICKNAME(NICKNAME);
        
        String result = myPageService.shareSchedule(myPageVO);
        
        if (result.equals("success")) {
            redirectAttributes.addFlashAttribute("message", NICKNAME + "ë‹˜ì—ê²Œ ì¼ì • ê³µìœ  ì„±ê³µ!");
        } else if(result.equals("Duplicate")){
            redirectAttributes.addFlashAttribute("message", "ì´ë¯¸ ê³µìœ í•œ íšŒì›ì…ë‹ˆë‹¤. ë‹‰ë„¤ì„ì„ í™•ì¸í•˜ì„¸ìš”!");
        } else {
        	redirectAttributes.addFlashAttribute("message", "ì¼ì • ê³µìœ  ì‹¤íŒ¨! ë‹‰ë„¤ì„ì„ í™•ì¸í•˜ì„¸ìš”!");
        }
        
        ModelAndView mav = new ModelAndView("board/redirectPostToMyPage"); // redirectPostToMyPage.jsp
        mav.addObject("MEMBER_ID", MEMBER_ID);
        return mav;

    }

    // ğŸ”¹ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í˜ì´ì§€ë¡œ ì´ë™
    @Override
    @RequestMapping(value = "/board/updatePassword.do", method = RequestMethod.POST)
    public ModelAndView showPasswordUpdatePage(HttpServletRequest request, HttpServletResponse response) {
        String memberId = request.getParameter("memberId");

        if (memberId == null || memberId.isEmpty()) {
            throw new IllegalArgumentException("íšŒì› IDê°€ ì—†ìŠµë‹ˆë‹¤.");
        }

        ModelAndView mav = new ModelAndView("board/passwordUpdate");
        mav.addObject("memberId", memberId);
        return mav;
    }
    
 // ğŸ”¹ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ìš”ì²­ ì²˜ë¦¬
    @Override
    @RequestMapping(value = "/board/updatePasswordDone.do", method = RequestMethod.POST)
    public ModelAndView updatePassword(HttpServletRequest request, HttpServletResponse response) throws Exception {
        String memberId = request.getParameter("memberId");
        String currentPassword = request.getParameter("currentPassword");
        String newPassword = request.getParameter("newPassword");
        String confirmPassword = request.getParameter("confirmPassword");

        // í•„ìˆ˜ê°’ ì²´í¬ ë° ë¹„ë°€ë²ˆí˜¸ í™•ì¸
        if (memberId == null || currentPassword == null || newPassword == null || confirmPassword == null) {
            return new ModelAndView("redirect:/board/passwordUpdate.do?error=empty");
        }

        if (!newPassword.equals(confirmPassword)) {
            return new ModelAndView("redirect:/board/passwordUpdate.do?error=mismatch");
        }

        // ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
        MemberVO member = myPageService.getMemberById(memberId);
        if (member == null || !currentPassword.equals(member.getPASSWORD())) {
            return new ModelAndView("redirect:/board/passwordUpdate.do?error=wrongPassword");
        }

        // ë¹„ë°€ë²ˆí˜¸ ì—…ë°ì´íŠ¸
        myPageService.updatePassword(memberId, newPassword);

        // ë§ˆì´í˜ì´ì§€ë¡œ ì´ë™
        return new ModelAndView("redirect:/board/myPage.do?success=passwordUpdated");
    }

    
    @Override
    @RequestMapping(value = "/board/updateNickname.do", method = RequestMethod.POST)
    public ModelAndView showNicknameUpdatePage(HttpServletRequest request, HttpServletResponse response) {
        String memberId = request.getParameter("memberId");

        if (memberId == null || memberId.isEmpty()) {
            throw new IllegalArgumentException("íšŒì› IDê°€ ì—†ìŠµë‹ˆë‹¤.");
        }

        ModelAndView mav = new ModelAndView("board/updateNickname");
        mav.addObject("memberId", memberId);
        return mav;
    }

    @Override
    @RequestMapping(value = "/board/updateNicknameDone.do", method = RequestMethod.POST)
    public ModelAndView updateNickname(HttpServletRequest request, HttpServletResponse response) throws Exception {
        String memberId = request.getParameter("memberId");
        String newNickname = request.getParameter("newNickname");

        if (memberId == null || newNickname == null) {
            return new ModelAndView("redirect:/board/updateNickname.do?error=empty");
        }

        myPageService.updateNickname(memberId, newNickname);
        return new ModelAndView("redirect:/board/myPage.do?MEMBER_ID=" + memberId + "&success=emailUpdated");
    }

    // ì´ë©”ì¼ ë³€ê²½
    @Override
    @RequestMapping(value = "/board/updateEmail.do", method = RequestMethod.POST)
    public ModelAndView showEmailUpdatePage(HttpServletRequest request, HttpServletResponse response) {
        String memberId = request.getParameter("memberId");

        ModelAndView mav = new ModelAndView("board/updateEmail");
        mav.addObject("memberId", memberId);
        return mav;
    }

    @Override
    @RequestMapping(value = "/board/updateEmailDone.do", method = RequestMethod.POST)
    public ModelAndView updateEmail(HttpServletRequest request, HttpServletResponse response) throws Exception {
        String memberId = request.getParameter("memberId");
        String newEmail = request.getParameter("newEmail");

        if (memberId == null || newEmail == null) {
            return new ModelAndView("redirect:/board/updateEmail.do?error=empty");
        }

        myPageService.updateEmail(memberId, newEmail);
        return new ModelAndView("redirect:/board/myPage.do?MEMBER_ID=" + memberId + "&success=emailUpdated");
    }






    // íœ´ëŒ€ì „í™”ë²ˆí˜¸ ë³€ê²½
    @Override
    @RequestMapping(value = "/board/updatePhoneNumber.do", method = RequestMethod.POST)
    public ModelAndView showPhoneNumberUpdatePage(HttpServletRequest request, HttpServletResponse response) {
        String memberId = request.getParameter("memberId");

        ModelAndView mav = new ModelAndView("board/updatePhoneNumber");
        mav.addObject("memberId", memberId);
        return mav;
    }

    @Override
    @RequestMapping(value = "/board/updatePhoneNumberDone.do", method = RequestMethod.POST)
    public ModelAndView updatePhoneNumber(HttpServletRequest request, HttpServletResponse response) throws Exception {
        String memberId = request.getParameter("memberId");
        String newPhoneNumber = request.getParameter("newPhoneNumber");

        if (memberId == null || newPhoneNumber == null) {
            return new ModelAndView("redirect:/board/updatePhoneNumber.do?error=empty");
        }

        myPageService.updatePhoneNumber(memberId, newPhoneNumber);
        return new ModelAndView("redirect:/board/myPage.do?MEMBER_ID=" + memberId + "&success=phoneNumberUpdated");
    }



}
